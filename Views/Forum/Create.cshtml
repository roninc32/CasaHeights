@model CreatePostViewModel
@{
    ViewData["Title"] = "Create New Discussion";
}

<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h2 class="h4 mb-4">Start a New Discussion</h2>

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form asp-controller="Forum" asp-action="Create" method="post" id="createPostForm">
                        @Html.AntiForgeryToken()
                        <div asp-validation-summary="All" class="alert alert-danger" role="alert"></div>

                        <div class="mb-3">
                            <label asp-for="Title" class="form-label"></label>
                            <input asp-for="Title" class="form-control" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Content" class="form-label"></label>
                            <textarea asp-for="Content" class="form-control" rows="10"></textarea>
                            <span asp-validation-for="Content" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Categories</label>
                            <div class="row g-2">
                                @if (Model.Categories != null)
                                {
                                    foreach (var category in Model.Categories)
                                    {
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input"
                                                       name="SelectedCategories" value="@category.Id"
                                                       id="cat_@category.Id" />
                                                <label class="form-check-label" for="cat_@category.Id">
                                                    @category.Name
                                                </label>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                            <span asp-validation-for="SelectedCategories" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Tags" class="form-label">Tags</label>
                            <div class="tag-input-container">
                                <input asp-for="Tags" class="form-control mb-2" 
                                    placeholder="Enter tags separated by commas" 
                                    id="tagInput" />
                                <div id="tagDescriptions" class="mt-2">
                                    <!-- Tag descriptions will be added here dynamically -->
                                </div>
                            </div>
                            <span asp-validation-for="Tags" class="text-danger"></span>
                            <div class="form-text">
                                Example: community, question, general
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-outline-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary" id="submitButton">
                                <i class="bi bi-chat-dots me-2"></i>Create Discussion
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            var tagInput = $('#tagInput');
            var tagDescriptionsContainer = $('#tagDescriptions');
            
            tagInput.on('change', function() {
                var tags = $(this).val().split(',')
                    .map(t => t.trim())
                    .filter(t => t.length > 0);
                
                tagDescriptionsContainer.empty();
                
                tags.forEach(function(tag) {
                    var descriptionHtml = `
                        <div class="mb-2">
                            <label class="form-label">Description for "${tag}"</label>
                            <input type="text" 
                                   name="TagDescriptions[${tag}]" 
                                   class="form-control"
                                   required
                                   placeholder="Enter description for ${tag}"
                                   value="Posts tagged with ${tag} in the Casa Heights community forum." />
                        </div>
                    `;
                    tagDescriptionsContainer.append(descriptionHtml);
                });
            });
        });
    </script>
}
